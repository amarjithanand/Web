<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=yes" />
  <title>FlipHTML5-style PDF Flip (Firestore)</title>

  <!-- PageFlip CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/css/page-flip.min.css" />

  <style>
    :root{
      --max-width:1080px;
      --bg:#2f2f2f;
      --toolbar-bg: rgba(0,0,0,0.85);
    }
    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      display:flex;
      justify-content:center;
      align-items:flex-start;
      font-family:system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
      color:#fff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .container{
      width:100%;
      max-width:var(--max-width);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      padding:12px;
      box-sizing:border-box;
    }

    /* Multimedia header */
    #multimedia {
      width:100%;
      background: #fafafa;
      color:#222;
      padding:8px 12px;
      border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,0.25);
      display:flex;
      gap:12px;
      align-items:center;
      min-height:64px;
      overflow:auto;
    }
    #multimedia .thumb{
      width:120px;
      height:70px;
      object-fit:cover;
      border-radius:6px;
      flex-shrink:0;
      background:#ddd;
    }
    #multimedia .meta{flex:1}
    #multimedia a{ color:#0b67ff; text-decoration:none; font-weight:600 }

    /* Book area */
    #book {
      width:100%;
      height: calc(100vh - 260px);
      max-height: 78vh;
      background:#fff;
      border-radius:6px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.6);
      overflow:hidden;
      position:relative;
    }

    .page{
      width:100%;
      height:100%;
      display:flex;
      justify-content:center;
      align-items:center;
      background:#fff;
    }

    .page canvas{ max-width:100%; max-height:100%; display:block; }

    /* toolbar similar to screenshot */
    #toolbar{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      padding:10px;
      background: var(--toolbar-bg);
      border-radius:6px;
      box-sizing:border-box;
      position:relative;
    }

    #toolbar .left, #toolbar .center, #toolbar .right{
      display:flex;
      align-items:center;
      gap:8px;
    }
    #toolbar .left{ flex:1; justify-content:flex-start; }
    #toolbar .center{ flex:0; justify-content:center; gap:10px; }
    #toolbar .right{ flex:1; justify-content:flex-end; }

    button.toolbtn{
      background:#1e88ff;
      border:none;
      color:white;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
      min-width:44px;
    }
    button.toolbtn:disabled{ background:#444; cursor:not-allowed; }

    #pageInfo{ font-weight:700; min-width:80px; text-align:center; }

    /* slider */
    #pageSlider{
      width:320px;
      appearance:none;
      height:6px;
      background:rgba(255,255,255,0.15);
      border-radius:6px;
      outline:none;
    }
    #pageSlider::-webkit-slider-thumb{
      appearance:none;
      width:16px;
      height:16px;
      border-radius:50%;
      background:#fff;
      border:2px solid #1e88ff;
      cursor:pointer;
    }

    /* loading overlay */
    #loading{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      background:rgba(0,0,0,0.7);
      color:#fff;
      padding:10px 14px;
      border-radius:6px;
      z-index:999;
      display:none;
    }

    /* small screens adjustments */
    @media (max-width:520px){
      #pageSlider{ width:160px; }
      #book{ height: calc(100vh - 220px); }
      #multimedia .thumb{ width:90px; height:60px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="multimedia">
      <img class="thumb" id="multimediaThumb" src="https://via.placeholder.com/300x200?text=No+media" alt="thumb">
      <div class="meta">
        <div id="multimediaTitle"><strong>No multimedia</strong></div>
        <div id="multimediaDesc"></div>
      </div>
      <div style="min-width:10px;"></div>
    </div>

    <div id="book">
      <div id="loading">Loading PDF...</div>
    </div>

    <div id="toolbar" aria-hidden="false">
      <div class="left">
        <button class="toolbtn" id="zoomOutBtn">-</button>
        <button class="toolbtn" id="zoomInBtn">+</button>
      </div>

      <div class="center">
        <button class="toolbtn" id="prevBtn">⟨</button>
        <div id="pageInfo">1 / 1</div>
        <button class="toolbtn" id="nextBtn">⟩</button>
        <input type="range" id="pageSlider" min="1" max="1" value="1" aria-label="page slider">
      </div>

      <div class="right">
        <!-- reserve for extras -->
      </div>
    </div>
  </div>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <!-- PageFlip -->
  <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>

  <!-- Firebase modular SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // ---------- FIREBASE CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDBznllARhkqgps9WzJK2lKsdl9cR7A1Js",
      authDomain: "flip-clone-19aa3.firebaseapp.com",
      projectId: "flip-clone-19aa3",
      storageBucket: "flip-clone-19aa3.appspot.com",
      messagingSenderId: "247235274877",
      appId: "1:247235274877:web:bc8e8951bd376e143b6914",
      measurementId: "G-GP585NZ91Z"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    // -------------------------------------

    // DOM refs
    const bookEl = document.getElementById('book');
    const loadingEl = document.getElementById('loading');
    const pageInfoEl = document.getElementById('pageInfo');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageSlider = document.getElementById('pageSlider');
    const zoomInBtn = document.getElementById('zoomInBtn');
    const zoomOutBtn = document.getElementById('zoomOutBtn');
    const multimediaThumb = document.getElementById('multimediaThumb');
    const multimediaTitle = document.getElementById('multimediaTitle');
    const multimediaDesc = document.getElementById('multimediaDesc');

    // state
    let flipbook;
    let pdf; // pdf.js PDFDocumentProxy
    let pagesHTML = []; // cached page elements (div.page)
    let zoomLevel = 1.5; // initial scale used for rendering
    let currentIndex = 0;

    // helper to show/hide loading
    function showLoading(msg = "Loading PDF..."){
      loadingEl.style.display = 'block';
      loadingEl.textContent = msg;
    }
    function hideLoading(){ loadingEl.style.display = 'none'; }

    // initialize flipbook with strict single-page settings
    function initFlipbook(){
      flipbook = new St.PageFlip(bookEl, {
        width: bookEl.clientWidth,
  height: bookEl.clientHeight,
  size: "fixed",        // stop auto spread
  showCover: false,     // never treat first page as cover
  usePortrait: true,    // always single-page mode
  singlePage: true,     // force one page at a time
  drawShadow: true,
  flippingTime: 600,
  maxShadowOpacity: 0.5,
  swipeDistance: 20,
  disableFlipByClick: false,   // ✅ allow clicks/taps
  mobileScrollSupport: true,
  autoSize: true,
  startPage: 0,
      });

      function safeFlipPrev() {
  const current = flipbook.getCurrentPageIndex();
  if (current > 0) {
    flipbook.flip(current - 1); // smooth animation to previous page
  }
}

function safeFlipNext() {
  const current = flipbook.getCurrentPageIndex();
  if (current < flipbook.getPageCount() - 1) {
    flipbook.flip(current + 1); // smooth animation to next page
  }
}


      // update UI on flip
      flipbook.on('flip', (e) => {
        // The library provides e.data as index
        currentIndex = flipbook.getCurrentPageIndex();
        updatePageUI();
        loadMultimediaForPage(currentIndex);
      });

      // prevent flipping beyond boundaries (safety)
      flipbook.on("changeState", (e) => {
        const idx = flipbook.getCurrentPageIndex();
        const total = flipbook.getPageCount();
        if ((e.data === "flipping" && idx === total - 1 && e.direction === "next") ||
            (e.data === "flipping" && idx === 0 && e.direction === "prev")) {
          e.preventDefault?.();
        }
      });

      // click to flip left/right
      bookEl.addEventListener('click', (ev) => {
        const rect = bookEl.getBoundingClientRect();
        const x = ev.clientX - rect.left;
        const mid = rect.width / 2;
        const total = flipbook.getPageCount();
        const idx = flipbook.getCurrentPageIndex();
        if (x < mid && idx > 0) flipbook.safeFlipPrev();
        else if (x >= mid && idx < total - 1) flipbook.safeFlipNext();
      });
    }

    // Render a single PDF page (pageNum is 1-based)
    async function renderPageElement(pageNum, scale = zoomLevel){
      const page = await pdf.getPage(pageNum);
      const viewport = page.getViewport({ scale });
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);

      // improve CRT rendering
      canvas.style.width = Math.min(canvas.width, bookEl.clientWidth) + 'px';
      canvas.style.height = Math.min(canvas.height, bookEl.clientHeight) + 'px';

      await page.render({ canvasContext: ctx, viewport }).promise;

      const pageDiv = document.createElement('div');
      pageDiv.className = 'page';
      pageDiv.appendChild(canvas);
      return pageDiv;
    }

    // Render ALL pages (we re-create pagesHTML array)
    async function renderAllPages(){
      showLoading('Rendering pages...');
      pagesHTML = [];
      const n = pdf.numPages;
      // Create in sequence to avoid huge memory spikes, but you can parallelize if desired
      for (let p = 1; p <= n; p++){
        try {
          const el = await renderPageElement(p, zoomLevel);
          pagesHTML.push(el);
        } catch (err) {
          console.error('Error rendering page', p, err);
          // create fallback element
          const fallback = document.createElement('div');
          fallback.className = 'page';
          fallback.innerHTML = `<div style="padding:30px;color:#333">Failed to render page ${p}</div>`;
          pagesHTML.push(fallback);
        }
      }
      hideLoading();
    }

    // Load PDF URL from Firestore and build viewer
    async function loadPdfFromFirestore(){
      showLoading('Fetching PDF URL from Firestore...');
      try {
        const pdfDocRef = doc(db, 'pdfs', 'main');
        const pdfSnap = await getDoc(pdfDocRef);
        if (!pdfSnap.exists() || !pdfSnap.data().pdfUrl){
          throw new Error('No pdfUrl found in pdfs/main');
        }
        const pdfUrl = pdfSnap.data().pdfUrl;
        showLoading('Loading PDF...');
        const loadingTask = pdfjsLib.getDocument(pdfUrl);
        pdf = await loadingTask.promise;
        // init flipbook then render pages
        initFlipbook();
        await renderAllPages();
        flipbook.loadFromHTML(pagesHTML);
        // set UI state
        currentIndex = 0;
        updatePageUI();
        loadMultimediaForPage(currentIndex);
      } catch (err){
        hideLoading();
        console.error(err);
        showLoading('Error: ' + err.message);
      } finally {
        hideLoading();
      }
    }

    // Update page info, slider and buttons
    function updatePageUI(){
      const total = flipbook.getPageCount();
      const idx = flipbook.getCurrentPageIndex();
      pageInfoEl.textContent = `${idx + 1} / ${total}`;
      pageSlider.max = total;
      pageSlider.value = idx + 1;
      prevBtn.disabled = idx === 0;
      nextBtn.disabled = idx === total - 1;
    }

    // Change page by index (0-based)
    function goToPage(index0){
      if (!flipbook) return;
      const total = flipbook.getPageCount();
      const clamped = Math.max(0, Math.min(total - 1, index0));
      flipbook.flip(clamped);
      // flip event will update UI & multimedia; but to be safe:
      currentIndex = clamped;
      updatePageUI();
      loadMultimediaForPage(currentIndex);
    }

    // multimedia loader: reads pages/{pageNumber} from Firestore
    async function loadMultimediaForPage(index0){
      const pageNum = index0 + 1;
      multimediaThumb.src = 'https://via.placeholder.com/300x200?text=Loading...';
      multimediaTitle.innerHTML = `<strong>Page ${pageNum}</strong>`;
      multimediaDesc.textContent = '';

      try {
        const pageDocRef = doc(db, 'pages', String(pageNum));
        const pageSnap = await getDoc(pageDocRef);
        if (!pageSnap.exists()){
          multimediaThumb.src = 'https://via.placeholder.com/300x200?text=No+media';
          multimediaTitle.innerHTML = `<strong>Page ${pageNum}</strong>`;
          multimediaDesc.textContent = 'No multimedia for this page.';
          return;
        }
        const data = pageSnap.data();
        // show different UI according to type
        if (data.type === 'image'){
          multimediaThumb.src = data.url;
          multimediaTitle.innerHTML = `<strong>${data.title || 'Image'}</strong>`;
          multimediaDesc.textContent = data.description || '';
        } else if (data.type === 'video'){
          multimediaThumb.src = data.thumbnail || 'https://via.placeholder.com/300x200?text=Video';
          multimediaTitle.innerHTML = `<strong>${data.title || 'Video'}</strong>`;
          multimediaDesc.innerHTML = `<a href="${data.url}" target="_blank">Play video</a>${data.description ? '<div>'+data.description+'</div>' : ''}`;
        } else if (data.type === 'audio'){
          multimediaThumb.src = data.thumbnail || 'https://via.placeholder.com/300x200?text=Audio';
          multimediaTitle.innerHTML = `<strong>${data.title || 'Audio'}</strong>`;
          multimediaDesc.innerHTML = `<audio controls style="max-width:200px"><source src="${data.url}"></audio>${data.description ? '<div>'+data.description+'</div>' : ''}`;
        } else if (data.type === 'link'){
          multimediaThumb.src = data.thumbnail || 'https://via.placeholder.com/300x200?text=Link';
          multimediaTitle.innerHTML = `<strong>${data.title || 'Link'}</strong>`;
          multimediaDesc.innerHTML = `<a href="${data.url}" target="_blank">${data.url}</a>${data.description ? '<div>'+data.description+'</div>' : ''}`;
        } else {
          multimediaThumb.src = 'https://via.placeholder.com/300x200?text=No+media';
          multimediaTitle.innerHTML = `<strong>${data.title || 'Multimedia'}</strong>`;
          multimediaDesc.textContent = data.description || '';
        }
      } catch (err){
        console.warn('multimedia load error', err);
        multimediaThumb.src = 'https://via.placeholder.com/300x200?text=Error';
        multimediaTitle.innerHTML = `<strong>Page ${pageNum}</strong>`;
        multimediaDesc.textContent = `Error loading multimedia`;
      }
    }

    // Zoom actions: we re-render all pages at new zoom level (keeps text crisp)
    async function changeZoom(newZoom){
      // clamp zoom
      zoomLevel = Math.max(0.6, Math.min(newZoom, 4.0));
      showLoading('Re-rendering pages at zoom ' + zoomLevel.toFixed(2));
      // render pages again
      await renderAllPages();
      // reload into flipbook and stay on same page index
      const prevIdx = currentIndex || 0;
      flipbook.loadFromHTML(pagesHTML);
      // flipbook may need small delay to initialize; ensure we set page after load
      setTimeout(() => {
        flipbook.flip(prevIdx);
        updatePageUI();
        loadMultimediaForPage(prevIdx);
        hideLoading();
      }, 150);
    }

    // UI handlers
    prevBtn.addEventListener('click', () => { flipbook?.safeFlipPrev(); });
    nextBtn.addEventListener('click', () => { flipbook?.safeFlipNext(); });

    pageSlider.addEventListener('input', (e) => {
      const val = Number(e.target.value);
      goToPage(val - 1);
    });

    zoomInBtn.addEventListener('click', () => changeZoom(zoomLevel + 0.5));
    zoomOutBtn.addEventListener('click', () => changeZoom(zoomLevel - 0.5));

    // resize handling: update flipbook size
    window.addEventListener('resize', () => {
      if (!flipbook) return;
      flipbook.update({
        width: bookEl.clientWidth,
        height: bookEl.clientHeight,
        singlePage: true
      });
    });

    // Scroll wheel navigation
let scrollTimeout;
bookEl.addEventListener("wheel", (e) => {
  clearTimeout(scrollTimeout);
  scrollTimeout = setTimeout(() => {
    if (e.deltaY > 0) {
      safeFlipNext();
    } else if (e.deltaY < 0) {
      safeFlipPrev();
    }
  }, 80);
});

// Touch swipe navigation
let touchStartY = 0;
bookEl.addEventListener("touchstart", (e) => {
  touchStartY = e.touches[0].clientY;
});

bookEl.addEventListener("touchend", (e) => {
  const deltaY = e.changedTouches[0].clientY - touchStartY;
  if (deltaY > 50) {
    safeFlipPrev();
  } else if (deltaY < -50) {
    safeFlipNext();
  }
});


    // initial load
    (async function init(){
      try {
        showLoading('Starting...');
        await loadPdfFromFirestore();
      } catch(err){
        console.error('Init error', err);
        showLoading('Error: ' + err.message);
      } finally {
        // hideLoading(); // already handled in functions
      }
    })();

  </script>
</body>
</html>
